<!DOCTYPE html>
<html>
<header th:include="header :: header"></header>
<head>
    <title>D-world/업무일지</title>
    <link rel="stylesheet" href="/css/WorkLog.css">
    <script>
        $(document).ready(function(){

            //업체 선택하지 않은 데이터 리턴시 대응
            if($("#cust-cd").val()==0){
                $("#cust-cd").val("");
            };

            //뒤로 버튼
            // $("#btn-back").on("click", function(){
            //     // location.href="/dworld/worklog";
            //     window.history.back();
            // });

            //업체명 검색 모달 컨트롤
            var searchCustNm = $("#searchCustNm").val();
            var datas = {searchCustNm};
            $("#searchCustNm").on("keyup",function(key){
                if(key.keyCode==13){
                    searchCustNm = $("#searchCustNm").val();
                    datas = {searchCustNm};
                    custListAjax();
                };
            });
            
            custListAjax();
            function custListAjax(){
                $.ajax({
                    url: "/dworld/worklog/searchCust",
                    type: "get",
                    data: datas,
                    success: function(data){
                        var listArea =$("#custListTable");
                        var listStr = "";
                        listArea.empty();
                        
                        if (data && data.length > 0) {
                            $.each(data, function(index, item){
                                listStr += "<tr onclick='SetCust("+item.rowNum+")'>";
                                listStr += "<td class='text-start text-truncate' id='selectCustNm"+item.rowNum+"'>"+item.custNm+"</td>"
                                listStr += "<td><div class='' id='selectCustCd"+item.rowNum+"'>"+item.custCd+"</div></td></tr>";
                            });
                            listArea.append(listStr);
                        } else {
                            listStr += "<tr><td colspan='2' class='text-center'>검색 결과가 없습니다.</td></tr>";
                            listArea.append(listStr);
                        }
                    }, error: function() {
                        Swal.fire("Error", "ajax 통신 오류 발생", "error");
                    }
                });
            };

            // 업체 등록 버튼
            $("#btn-insertCust").on("click", function(){
                Swal.fire({
                    title: "간편 업체 등록"
                  , text: "업체명을 입력해주세요."
                  , input: "text"
                  , icon: "info"
                  , inputAttributes: {
                        autocapitalize: "off"}
                  , showCancelButton: true
                  , confirmButtonText: "Add Customer"
                //   , showLoaderOnConfirm: true
                //   , allowOutsideClick: () => !Swal.isLoading()
                }).then((result) => {
                    if (result.isConfirmed) {
                        var datas = {custNm: `${result.value}`}
                        $.ajax({
                            url: "/dworld/customer/control",
                            type: "post",
                            data: datas,
                            success: function(data) {
                                if(data == "custNmEmpty"){
                                    Swal.fire("","업체명이 비어선 안됩니다.", "warning");
                                } else{
                                    if(data == "OK"){
                                        Swal.fire("","등록 되었습니다.", "success")
                                            .then((result)=>{
                                                if(result){
                                                    location.reload();
                                                }
                                            });
                                    }else{
                                        Swal.fire("","접근이 잘못되었습니다.", "error");
                                    } 
                                }
                            }, error: function() {
                                Swal.fire("","ajax 통신 오류 발생", "error");
                            }
                        });
                    }
                });
            });

            //업무일지 등록
            $("#btn-insert").on("click", function() {
                var custCd = $("#cust-cd").val();
                if(custCd == ""){
                    custCd = 0;
                };
                
                var receiptDt = $("#receipt-dt").val();
                var dueDt = $("#due-dt").val();
                var complDt = $("#compl-dt").val();
                var complYn;
                if(complDt == ""){
                    complYn = "N";
                }else{
                    complYn = "Y";
                }
                
                var title = $("#title").val();
                var content = $("#content").val();
                var datas = {custCd, receiptDt, dueDt, complDt, complYn, title, content};

                if(!title.trim()){
                    Swal.fire("Title Empty", "제목을 써주세요.", "warning");
                }else if(!content.trim()){
                    Swal.fire("Content Empty", "내용을 써주세요.", "warning");
                }else{
                    $.ajax({
                        url: "/dworld/worklog/control",
                        type: "post",
                        data: datas,
                        success: function(data) {
                            if(data == "OK"){
                                Swal.fire("Success", "등록 되었습니다.", "success")
                                .then((result)=>{
                                    if(result){
                                        location.href="/dworld/worklog";
                                    }
                                });
                                
                            }else{
                                Swal.fire("Error", "접근이 잘못되었습니다.", "error");
                            }
                        }, error: function() {
                            alert("ajax 통신 오류 발생");
                        }
                    });
                }
            });

        });

        //업체 선택 버튼 클릭 이벤트
        function SetCust(rowNum){
            console.log("rownum:"+rowNum);
            $('#selectCustModal').modal('hide');

            var selectCustNm = $("#selectCustNm"+rowNum).text();
            var selectCustCd = $("#selectCustCd"+rowNum).text();

            $("#cust-nm").val(selectCustNm);
            $("#cust-cd").val(selectCustCd);
        };
        
        //업체 선택 취소
        function SelectCancel(){
            $("#cust-nm").val("");
            $("#cust-cd").val("");
        };

        //삭제 버튼 이벤트
        function DeleteWorkLog(idx){
            var datas = {idx};

            Swal.fire({
                title : "Delete Request"
              , text : "삭제 하시겠습니까?"
              , icon : "warning"
              , showCancelButton: true
              , confirmButtonColor: '#3085d6'
              , cancelButtonColor: '#d33'
              , confirmButtonText: 'OK! Delete.'
              , cancelButtonText: 'Cancel', 
            }).then((result)=>{
                if(result.isConfirmed){
                    $.ajax({
                        url: "/dworld/worklog/control",
                        type: "delete",
                        data: datas,
                        success: function(data) {
                            if(data == "OK"){
                                Swal.fire("Success", "삭제 되었습니다.", "success")
                                .then((result)=>{
                                    if(result){
                                        location.href="/dworld/worklog";
                                    }
                                });
                                
                            }else{
                                Swal.fire("Error", "접근이 잘못되었습니다.", "error");
                            }
                        }, error: function() {
                            alert("ajax 통신 오류 발생");
                        }
                    });
                }
            })
        };

        //수정버튼 클릭 이벤트
        function UpdateWorkLog(idx) {
            Swal.fire({
                title : "Update Request"
              , text : "수정 하시겠습니까?"
              , icon : "warning"
              , showCancelButton: true
              , confirmButtonColor: '#3085d6'
              , cancelButtonColor: '#d33'
              , confirmButtonText: 'OK! Save'
              , cancelButtonText: 'Cancel', 
            }).then((result)=>{
                if(result.isConfirmed){
                    var custCd = $("#cust-cd").val();
                    if(custCd == ""){
                        custCd = 0;
                    };
                    var receiptDt = $("#receipt-dt").val();
                    var dueDt = $("#due-dt").val();
                    var complDt = $("#compl-dt").val();
                    var complYn;
                    if(complDt == ""){
                        complYn = "N";
                    }else{
                        complYn = "Y";
                    }
                    var title = $("#title").val();
                    var content = $("#content").val();
                    var datas = {custCd, receiptDt, dueDt, complDt, complYn, title, content, idx};

                    if(!title.trim()){
                        Swal.fire("Title Empty", "제목을 써주세요.", "warning");
                    }else {
                        if(!content.trim()){
                        Swal.fire("Content Empty", "내용을 써주세요.", "warning");
                        }else{
                            $.ajax({
                                url: "/dworld/worklog/control",
                                type: "put",
                                data: datas,
                                success: function(data) {
                                    if(data == 'OK'){
                                        Swal.fire("Success", "수정 되었습니다.", "success");
                                    }else{
                                        Swal.fire("Error", "접근이 잘못되었습니다.", "error");
                                    }
                                }, error: function() {
                                    alert("ajax 통신 오류 발생");
                                }
                            });
                        }
                    }
                }
            })
        };
    </script>
</head>
<body>
    <div class="container">
        <div class="text-center webfont1 dlh-headstyle">
            <label><h1 th:text="${MODE == 'new' ? 'Write New WorkLog' : 'WorkLog Detail'}"></h1></label>
        </div>
        <div class="row g-2 col-md-6 ms-md-auto col-lg-3 my-3">
            <div th:if="${MODE} == 'new'" class="col">
                <button type="button" class="col-12 btn btn-dark border-primary" id="btn-insert" name="btn-insert">Insert</button>
            </div>
            <div th:if="${MODE} == 'detail'" class="col">
                <button type="button" class="col-12 btn btn-dark border-secondary" id="btn-edit" name="btn-edit" th:onclick="|UpdateWorkLog(${WorkLogDetail.idx})|">Save</button>
            </div>
            <div th:if="${MODE} == 'detail'" class="col">
                <button type="button" class="col-12 btn btn-dark border-danger" id="btn-delete" name="btn-delete" th:onclick="|DeleteWorkLog(${WorkLogDetail.idx})|">Delete</button>
            </div>
            <div class="col">
                <button type="button" class="col-12 btn btn-dark border-success" id="btn-back" name="btn-back" th:onclick="|location.href='@{${prevPage}}'|">Back</button> 
            </div>
        </div>
        <div class="row g-2 mt-1">
            <div class="col-6 col-md-6 col-lg-3 form-floating">
                <input th:attr="value=${MODE == 'detail'} ? ${WorkLogDetail.custNm}" type="text" class="form-control" id="cust-nm" name="cust-nm" disabled>
                <label for="cust-nm">업체명</label>
            </div>
            <div class="col-6 col-md-6 col-lg-3 form-floating">
                <input th:attr="value=${MODE == 'detail'} ? ${WorkLogDetail.custCd}" type="text" class="form-control" id="cust-cd" name="cust-cd" disabled>                
                <label for="cust-cd">업체코드</label>
            </div>
            <div class="col-6 col-md-3 col-lg-auto">
                <button type="button" class="w-100 h-100 btn btn-dark border-primary text-nowrap" data-bs-toggle="modal" data-bs-target="#selectCustModal">업체 선택</button>
            </div>
            <div class="col-6 col-md-3 col-lg-auto">
                <button type="button" class="w-100 h-100 btn btn-dark border-warning text-nowrap" onclick="SelectCancel()">선택 취소</button>
            </div>
            <div class="col-6 col-md-3 col-lg-auto">
                <button type="button" id="btn-insertCust" class="w-100 h-100 btn btn-dark border-info text-nowrap">업체 등록</button>
            </div>
        </div>
        <!-- 업체 선택 modal -->
        <div class="modal fade" id="selectCustModal" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="staticBackdropLabel">업체 선택 팝업</h1>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input class="form-control my-2" type="text" list="custNmList" id="searchCustNm" name="searchCustNm" placeholder="업체명 검색" autocomplete="off">
                        <datalist id="custNmList">
                            <option th:each="list : ${CustNmList}" th:value="${list.custNm}"></option>
                        </datalist>
                        <div style="max-height: 400px; overflow:auto" id="custListDiv" name="custListDiv">
                            <table class="table table-dark table-striped" style="table-layout:fixed; cursor:pointer;">
                                <colgroup>
                                    <col width="75%">
                                    <col width="25%">
                                </colgroup>
                                <thead>
                                    <th>업체명</th>
                                    <th>업체코드</th>
                                </thead>
                                <tbody id="custListTable" name="custListTable">

                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div> -->
                </div>
            </div>
        </div>

        <div class="row g-2 mt-1">
            <div class="col-6 col-lg-3 form-floating">
                <input th:attr="value=${MODE == 'detail'} ? ${WorkLogDetail.insertDt}" type="datetime-local" class="form-control" id="insert-dt" name="insert-dt" disabled>
                <label for="insert-dt" class="mx-1">작성일</label>
            </div>
            <div class="col-6 col-lg-3 form-floating">
                <input th:attr="value=${MODE == 'detail'} ? ${WorkLogDetail.receiptDt}" type="datetime-local" class="form-control" id="receipt-dt" name="receipt-dt">
                <label for="receipt-dt" class="mx-1">접수일</label>
            </div>
            <div class="col-6 col-lg-3 form-floating">
                <input th:attr="value=${MODE == 'detail'} ? ${WorkLogDetail.dueDt}" type="datetime-local" class="form-control" id="due-dt" name="due-dt">
                <label for="due-dt" class="mx-1">마감예정일</label>
            </div>
            <div class="col-6 col-lg-3 form-floating">
                <input th:attr="value=${MODE == 'detail'} ? ${WorkLogDetail.complDt}" type="datetime-local" class="form-control" id="compl-dt" name="compl-dt">
                <label for="compl-dt" class="mx-1">완료일</label>
            </div>
        </div>
        <div class="form-floating my-2">
            <input th:attr="value=${MODE == 'detail'} ? ${WorkLogDetail.title}" type="text" class="form-control" id="title" name="title">
            <label for="title" class="mx-1">제목</label>
        </div>
        <div class="form-floating">
            <textarea th:text="${MODE == 'detail'} ? ${WorkLogDetail.content}" type="text" class="form-control" style="height: 500px;" id="content" name="content"></textarea>
            <label for="content" class="mx-1">내용</label>
        <div>
    </div>
</body>
</html>